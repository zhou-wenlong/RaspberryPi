## RocketChat_install

| 項     番 | サーバ区分            | 作業者 | 想定     時間 | 作業項目                            | 作業内容                                                     | チェック                                                     | 作業時刻 | 備考                                                         |
| --------- | --------------------- | ------ | ------------- | ----------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | -------- | ------------------------------------------------------------ |
| 1         | 测试Rocket.Chatサーバ |        | 0:00:02       | 登陆Rocket.Chatサーバ               | localhost  login: root     Password:********                 | 测试Rocket.Chatサーバへログインできること                    |          | 此处输入安装系统时设置的root 密码     (采用最小化安装的CentOS 7.2 x86_64操作系统 ) |
| 2         | 测试Rocket.Chatサーバ |        | 0:00:06       | 设置主机名                          | [root@localhost  ~]# hostnamectl set-hostname RocketChat     [root@localhost ~]# echo "192.168.92.130   rocketchat" >>   /etc/hosts | [root@localhost  ~]#hostname     rocketchat                  |          | 主机名自己定义，我这里设置成RocketChat     (本文档中所使用的IP地址192.168.92.130 是安装Rocket.Chat这台服务器的IP地址) |
| 3         | 测试Rocket.Chatサーバ |        | 0:02:00       | 设置IP地址                          | [root@rocketchat  ~]# sed -i s#BOOTPROTO=dhcp#BOOTPROTO=none#  /etc/sysconfig/network-scripts/ifcfg-eth0     [root@rocketchat ~]# sed -i s#ONBOOT=no#ONBOOT=yes#  /etc/sysconfig/network-scripts/ifcfg-eth0     [root@rocketchat ~]# echo "IPADDR=192.168.92.130" >>  /etc/sysconfig/network-scripts/ifcfg-eth0     [root@rocketchat ~]# echo "NETMASK=255.255.255.0" >>  /etc/sysconfig/network-scripts/ifcfg-eth0     [root@rocketchat ~]# echo "GATEWAY=192.168.92.254" >>  /etc/sysconfig/network-scripts/ifcfg-eth0 | [root@localhost  ~]cat /etc/sysconfig/network-scripts/ifcfg-eth0          TYPE=Ethernet     PROXY_METHOD=none     BROWSER_ONLY=no     BOOTPROTO=none     DEFROUTE=yes     IPV4_FAILURE_FATAL=no     IPV6INIT=yes     IPV6_AUTOCONF=yes     IPV6_DEFROUTE=yes     IPV6_FAILURE_FATAL=no     IPV6_ADDR_GEN_MODE=stable-privacy     NAME=eth0     UUID=7bee5551-b401-430f-84d0-72fe7b7cc191     DEVICE=eth0     ONBOOT=yes     IPADDR=192.168.92.130     NETMASK=255.255.255.0     GATEWAY=192.168.92.254 |          | /etc/sysconfig/network-scripts/ifcfg-eth0这个网卡设备名需要根据实际设备名设置     (192.168.92.130这个IP 地址需要能访问Internet，有下载权限) |
| 4         | 测试Rocket.Chatサーバ |        | 0:00:08       | DNS设置                             | [root@rocketchat  ~]# echo "nameserver 4.2.2.2" > /etc/resolv.conf     [root@rocketchat ~]# echo "nameserver 8.8.8.8" >>  /etc/resolv.conf | [root@rocketchat  ~]# cat /etc/resolv.conf     nameserver 4.2.2.2     nameserver 8.8.8.8 |          | 增加internet的DNS服务器IP地址                                |
| 5         | 测试Rocket.Chatサーバ |        | 0:00:08       | 防火墙设置                          | [root@rocketchat  ~]# systemctl stop firewalld.service      [root@rocketchat ~]# systemctl disable firewalld.service | [root@rocketchat  ~]# systemctl status firewalld.service     ● firewalld.service - firewalld - dynamic firewall daemon       Loaded: loaded  (/usr/lib/systemd/system/firewalld.service; disabled; vendor preset: enabled)       Active:  inactive (dead)        Docs: man:firewalld(1)          Jan 15 02:42:21 rocketchat systemd[1]: Starting firewalld - dynamic  firewall daemon...     Jan 15 02:42:21 rocketchat systemd[1]: Started firewalld - dynamic firewall  daemon.     Jan 15 04:06:33 rocketchat systemd[1]: Stopping firewalld - dynamic  firewall daemon...     Jan 15 04:06:34 rocketchat systemd[1]: Stopped firewalld - dynamic firewall  daemon. |          | 关闭防火墙     禁用防火墙                                    |
| 6         | 测试Rocket.Chatサーバ |        | 0:02:00       | 关闭SElinux设置                     | [root@rocketchat  ~]# sed -i s#SELINUX=enforcing#SELINUX=disabled# /etc/selinux/config     [root@rocketchat ~]# reboot     localhost login: root     Password:******** | [root@rocketchat ~]# sestatus     SELinux status:         disabled |          | 更改完SELinux的设置后     需要重新启动系统并再次登陆     最后通过sestatus命令验证 |
| 7         | 测试Rocket.Chatサーバ |        | 0:02:00       | 安装依赖软件                        | [root@rocketchat  ~]# yum -y install epel-release  curl gcc-c++     [root@rocketchat ~]# yum -y install  GraphicsMagick | [root@rocketchat  ~]# rpm -qa \| egrep 'epel-release\|curl\|gcc\|GraphicsMagick'     libgcc-4.8.5-36.el7.x86_64     libcurl-7.29.0-51.el7.x86_64     gcc-4.8.5-36.el7.x86_64     curl-7.29.0-51.el7.x86_64     epel-release-7-11.noarch     GraphicsMagick-1.3.31-2.el7.x86_64     gcc-c++-4.8.5-36.el7.x86_64     python-pycurl-7.19.0-19.el7.x86_64 |          |                                                              |
| 8         | 测试Rocket.Chatサーバ |        | 0:00:05       | 创建新的系统用户rocket              | [root@rocketchat  ~]# useradd -m -U -r -d /opt/rocket rocket     [root@rocketchat ~]# chmod 750 /opt/rocket | [root@rocketchat  ~]# grep rocket /etc/passwd     rocket:x:997:995::/opt/rocket:/bin/bash     [root@rocketchat ~]# ll -d /opt/rocket     drwxr-x--- 2 rocket  rocket 62 Jan 15 21:04 /opt/rocket |          |                                                              |
| 9         | 测试Rocket.Chatサーバ |        | 0:00:02       | 切换到rocket用户环境                | [root@rocketchat  ~]# su - rocket                            | [rocket@rocketchat  ~]$ id     uid=997(rocket) gid=995(rocket) groups=995(rocket) |          |                                                              |
| 10        | 测试Rocket.Chatサーバ |        | 0:10:00       | 用curl下载最新的Rocket.Chat稳定版本 | [rocket@rocketchat  ~]$ curl -L https://releases.rocket.chat/latest/download -o rocket.chat.tgz | [rocket@rocketchat  ~]$ ll     total 153248     -rw-rw-r-- 1 rocket rocket 156923996 Jan 15 22:16  rocket.chat.tgz |          |                                                              |
| 11        | 测试Rocket.Chatサーバ |        | 0:02:00       | 解压rocket.chat.tgz并重命名         | [rocket@rocketchat  ~]$ tar -zxv -f rocket.chat.tgz     [rocket@rocketchat ~]$ mv bundle rocket.chat | [rocket@rocketchat ~]$ ll     total 153248     drwxr-xr-x 4 rocket rocket    107 Jan 7 11:31 rocket.chat     -rw-rw-r-- 1 rocket rocket 156923996 Jan 15 22:16 rocket.chat.tgz |          |                                                              |
| 12        | 测试Rocket.Chatサーバ |        | 0:00:02       | 进入Rocket.Chat目录查看所需信息     | [rocket@rocketchat  ~]$ cd rocket.chat     [rocket@rocketchat rocket.chat]$ cat README | [rocket@rocketchat  rocket.chat]$ cat README      This is a Meteor application bundle. It has only one external  dependency:     Node.js v8.11.4. To run the  application:           $ (cd programs/server &&  npm install)      $ export  MONGO_URL='mongodb://user:password@host:port/databasename'      $ export  ROOT_URL='http://example.com'      $ export  MAIL_URL='smtp://user:password@mailhost:port/'      $ node main.js          Use the PORT environment variable to set the port where the     application will listen. The default is 80, but that will require     root on most systems.          Find out more about Meteor at meteor.com. |          | 了解README中的内容     后续操作会用到                        |
| 13        | 测试Rocket.Chatサーバ |        | 0:00:30       | 安装Node.js和npm并更新openssl       | [rocket@rocketchat  rocket.chat]$ exit     [root@rocketchat ~]# yum -y install nodejs npm     [root@rocketchat ~]# yum -y update openssl | [root@rocketchat  ~]# rpm -qa \| egrep 'nodejs\|npm\|openssl'     npm-3.10.10-1.6.14.3.1.el7.x86_64     openssl-libs-1.0.2k-16.el7.x86_64     nodejs-6.14.3-1.el7.x86_64     openssl-1.0.2k-16.el7.x86_64 |          | 在执行yum命令之前需要执行 exit命令退回到root用户             |
| 14        | 测试Rocket.Chatサーバ |        | 0:00:20       | 安装Node.js                         | [root@rocketchat  ~]# npm install -g inherits n     [root@rocketchat ~]# n 8.11.4 | [root@rocketchat  ~]# n      ο node/8.11.4          node/8.11.4 |          | 安装上两部README中显示的     Node.js的版本v8.11.4            |
| 15        | 测试Rocket.Chatサーバ |        | 0:03:00       | 安装MongoDB                         | ①新建安装mondodb的yum源     [root@rocketchat ~]# echo '[mongodb-org-3.2]' >  /etc/yum.repos.d/mongodb-org-3.2.repo     [root@rocketchat ~]# echo 'name=MongoDB Repository' >>  /etc/yum.repos.d/mongodb-org-3.2.repo     [root@rocketchat ~]# echo 'baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.2/x86_64/'  >> /etc/yum.repos.d/mongodb-org-3.2.repo     [root@rocketchat ~]# echo 'gpgcheck=0' >>  /etc/yum.repos.d/mongodb-org-3.2.repo     [root@rocketchat ~]# echo 'enabled=1' >>  /etc/yum.repos.d/mongodb-org-3.2.repo     ②安装mongodb     [root@rocketchat ~]# yum -y install mongodb-org     ③修改内核参数     [root@rocketchat ~]# echo 'echo  "never" >> /sys/kernel/mm/transparent_hugepage/enabled'  >> /etc/rc.d/rc.local     [root@rocketchat ~]# echo 'echo "never" >>  /sys/kernel/mm/transparent_hugepage/defrag' >> /etc/rc.d/rc.local     [root@rocketchat ~]# chmod 755 /etc/rc.d/rc.local     ④设置操作系统打开文件最大数和进程最大数     [root@rocketchat ~]# echo 'mongod soft nofile  64000' >> /etc/security/limits.conf     [root@rocketchat ~]# echo 'mongod hard nofile 64000' >>  /etc/security/limits.conf     [root@rocketchat ~]# echo 'mongod soft nproc 32000' >> /etc/security/limits.conf     [root@rocketchat ~]# echo 'mongod hard nproc 32000' >>  /etc/security/limits.conf     ⑤重新启动系统     [root@rocketchat ~]# reboot | [root@rocketchat  ~]# cat /etc/yum.repos.d/mongodb-org-3.2.repo      [mongodb-org-3.2]     name=MongoDB Repository      baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/3.2/x86_64/     gpgcheck=0     enabled=1     [root@rocketchat ~]# rpm -qa \| grep mongodb     mongodb-org-server-3.2.22-1.el7.x86_64     mongodb-org-mongos-3.2.22-1.el7.x86_64     mongodb-org-3.2.22-1.el7.x86_64     mongodb-org-shell-3.2.22-1.el7.x86_64     mongodb-org-tools-3.2.22-1.el7.x86_64     [root@rocketchat ~]# grep echo /etc/rc.d/rc.local       echo "never" >>  /sys/kernel/mm/transparent_hugepage/enabled     echo "never" >>  /sys/kernel/mm/transparent_hugepage/defrag     [root@rocketchat ~]# ll /etc/rc.d/rc.local      -rwxr-xr-x. 1 root root 592 Jan 16 01:31  /etc/rc.d/rc.local     [root@rocketchat ~]# grep mongod /etc/security/limits.conf      mongod soft nofile 64000     mongod hard nofile 64000     mongod soft nproc 32000     mongod hard nproc 32000     [root@rocketchat ~]# systemctl status mongod     ● mongod.service - SYSV: Mongo is a scalable,  document-oriented database.       Loaded: loaded  (/etc/rc.d/init.d/mongod; bad; vendor preset: disabled)       Active: active (running) since Thu 2019-01-17 02:40:09 EST; 11min ago        Docs:  man:systemd-sysv-generator(8)       CGroup:  /system.slice/mongod.service           └─939 /usr/bin/mongod -f  /etc/mongod.conf          Jan 17 02:40:08 rocketchat systemd[1]: Starting SYSV: Mongo is a scalable,  document-oriented database....     Jan 17 02:40:08 rocketchat runuser[904]: pam_unix(runuser:session): session  opened for user mongod by (uid=0)     Jan 17 02:40:09 rocketchat runuser[904]: pam_unix(runuser:session): session  closed for user mongod     Jan 17 02:40:09 rocketchat mongod[866]: Starting mongod: [ OK   ]     Jan 17 02:40:09 rocketchat systemd[1]: Started SYSV: Mongo is a scalable,  document-oriented database.. |          |                                                              |
| 16        | 测试Rocket.Chatサーバ |        | 0:05:00       | 安装Rocket.Chat                     | ①登陆系统     localhost login: root     Password:********     ②切换到rocket用户     [root@rocketchat ~]# su - rocket     ③增加环境变量     [rocket@rocketchat ~]$ echo 'export PORT=3000' >> .bash_profile       [rocket@rocketchat ~]$ echo 'export ROOT_URL=http://192.168.92.130:3000/'  >> .bash_profile      [rocket@rocketchat ~]$ echo 'export MONGO_URL=mongodb://localhost:27017/rocketchat'  >> .bash_profile     ④使新增变量生效     [rocket@rocketchat ~]$ source .bash_profile     ⑤安装     [rocket@rocketchat ~]$ cd ./rocket.chat/programs/server/     [rocket@rocketchat server]$ npm install     [rocket@rocketchat server]$ cd ../../     [rocket@rocketchat rocket.chat]$ node main.js     ⑥     Ctrl+ c 停止Rocket.Chat服务     ⑦创建Rocket.Chat服务的systemd单元     [rocket@rocketchat server]$ exit     [root@rocketchat ~]# echo '[Unit]' >>  /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo 'Description=Rocket.Chat server' >>  /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo 'After=network.target nss-lookup.target  mongod.target' >> /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo '[Service]' >>  /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo 'StandardOutput=syslog' >>  /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo 'StandardError=syslog' >>  /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo 'SyslogIdentifier=rocketchat' >> /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo 'User=rocket' >>  /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo  'Environment=MONGO_URL=mongodb://localhost:27017/rocketchat  ROOT_URL=http://192.168.92.130:3000/ PORT=3000' >>  /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo 'ExecStart=/usr/local/bin/node  /opt/rocket/rocket.chat/main.js' >>  /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo '[Install]' >>  /etc/systemd/system/rocketchat.service     [root@rocketchat ~]# echo 'WantedBy=multi-user.target' >>  /etc/systemd/system/rocketchat.service     ⑧重新加载systemd管理器配置     [root@rocketchat ~]# systemctl  daemon-reload     ⑨启动rocketchat服务     [root@rocketchat ~]# systemctl start  rocketchat.service     ⑩设置rocketchat跟随操作系统自启动     [root@rocketchat ~]# systemctl enable  rocketchat.service | [rocket@rocketchat  ~]$ id     uid=997(rocket) gid=995(rocket) groups=995(rocket)     [rocket@rocketchat ~]$ grep export .bash_profile      export PATH     export PORT=3000     export ROOT_URL=http://192.168.92.130:3000/     export MONGO_URL=mongodb://localhost:27017/rocketchat     [rocket@rocketchat ~]$ env \| egrep  'PORT\|ROOT_URL\|MONGO_URL'     MONGO_URL=mongodb://localhost:27017/rocketchat     ROOT_URL=http://192.168.92.130:3000/     PORT=3000     [root@rocketchat ~]# cat  /etc/systemd/system/rocketchat.service      [Unit]     Description=Rocket.Chat server     After=network.target nss-lookup.target mongod.target     [Service]     StandardOutput=syslog     StandardError=syslog     SyslogIdentifier=rocketchat     User=rocket     Environment=MONGO_URL=mongodb://localhost:27017/rocketchat  ROOT_URL=http://192.168.92.130:3000/ PORT=3000     ExecStart=/usr/local/bin/node /opt/rocket/rocket.chat/main.js     [Install]     WantedBy=multi-user.target     [root@rocketchat ~]# systemctl status rocketchat.service     ● rocketchat.service - Rocket.Chat server       Loaded: loaded  (/etc/systemd/system/rocketchat.service; disabled; vendor preset:  disabled)       Active: active (running) since Wed  2019-01-16 20:59:06 EST; 2min 4s ago      Main PID: 19033 (node)       CGroup: /system.slice/rocketchat.service           └─19033  /usr/local/bin/node /opt/rocket/rocket.chat/main.js          Jan 16 20:59:47 rocketchat rocketchat[19033]: ? \| Rocket.Chat Version: 0.73.2            \|     Jan 16 20:59:47 rocketchat rocketchat[19033]: ? \|    NodeJS Version: 8.11.4 - x64         \|     Jan 16 20:59:47 rocketchat rocketchat[19033]: ? \|       Platform: linux            \|     Jan 16 20:59:47 rocketchat rocketchat[19033]: ? \|     Process Port: 3000             \|     Jan 16 20:59:47 rocketchat rocketchat[19033]: ? \|       Site URL: http://192.168.92.130:3000/ \|     Jan 16 20:59:47 rocketchat rocketchat[19033]: ? \|   ReplicaSet OpLog: Disabled           \|     Jan 16 20:59:47 rocketchat rocketchat[19033]: ? \|     Commit Hash: 8ff0e3da16          \|     Jan 16 20:59:47 rocketchat rocketchat[19033]: ? \|    Commit Branch: HEAD             \|     Jan 16 20:59:47 rocketchat rocketchat[19033]: ? \|                            \|     Jan 16 20:59:47 rocketchat rocketchat[19033]: ?  +----------------------------------------------------+ |          | 执行[rocket@rocketchat rocket.chat]$  node main.js后有以下信息输出说明安装成功          Rocket.Chat Version: 0.73.2     NodeJS Version: 8.11.4 - x64     Platform: linux     Process Port: 3000     Site URL: http://192.168.92.130:3000/     ReplicaSet OpLog: Disabled     Commit Hash: 8ff0e3da16      Commit Branch: HEAD |
| 17        | 测试Rocket.Chatサーバ |        | 0:00:05       | 浏览器访问                          | 打开浏览器并键入：http://192.168.92.130:3000                 | ![img](file:///C:/Users/SD10590/AppData/Local/Temp/msohtmlclip1/01/clip_image002.png) |          |                                                              |
|           |                       |        |               |                                     |                                                              |                                                              |          |                                                              |
|           |                       |        |               |                                     |                                                              |                                                              |          |                                                              |

